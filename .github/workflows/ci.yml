# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# -----------------------------------------------------------------------------
# CI Workflow â€” Travel-Plan-Permission
# -----------------------------------------------------------------------------
# Uses reusable Python CI from stranske/Workflows.
#
# NOTE: Cannot use `needs` to reference a reusable workflow job from a regular
# job - this causes startup_failure. Gate job pattern must use workflow_run
# trigger in a separate workflow or rely on GitHub required checks.
#
# Pin reference: stranske/Workflows@07c3a6ce10ff00953624e9f0705c44190ec7b33c
# -----------------------------------------------------------------------------

name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Local validation jobs (run in parallel with Python CI)
  actionlint:
    name: Actionlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run actionlint
        uses: raven-actions/actionlint@v2
        with:
          flags: "-color"

  docs-lint:
    name: Docs Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !**/node_modules/**
      - name: Link check
        uses: lycheeverse/lychee-action@v1
        with:
          args: --no-progress --exclude-mail --accept 200,429 -- .**/*.md *.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  schema-validate:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Compile schemas
        run: |
          npx ajv compile --spec=draft2020 -c ajv-formats -s schemas/trip_plan.min.schema.json
          npx ajv compile --spec=draft2020 -c ajv-formats -s schemas/expense_report.min.schema.json
      - name: Validate fixture data
        run: |
          npx ajv validate --spec=draft2020 -c ajv-formats \
            -s schemas/trip_plan.min.schema.json \
            -d tests/fixtures/sample_trip_plan_minimal.json
          npx ajv validate --spec=draft2020 -c ajv-formats \
            -s schemas/expense_report.min.schema.json \
            -d tests/fixtures/sample_expense_report_minimal.json

  # Reusable Python CI from stranske/Workflows
  python-ci:
    name: Python CI
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@07c3a6ce10ff00953624e9f0705c44190ec7b33c
    with:
      python-versions: '["3.11", "3.12"]'
      coverage-min: "80"
    secrets: inherit
