# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# -----------------------------------------------------------------------------
# Maint 51: Dependency Refresh Workflow
# -----------------------------------------------------------------------------
# Regenerates requirements.lock and requirements-dev.lock using pip-compile,
# verifies tool-pin alignment, and opens a refresh PR when dependency updates
# are detected.
#
# Schedule: 1st and 15th of each month at 04:00 UTC
# Manual: Actions → Dependency Refresh → Run workflow
# -----------------------------------------------------------------------------

name: Maint 51 Dependency Refresh

on:
  schedule:
    # Run on 1st and 15th of each month at 04:00 UTC
    - cron: "0 4 1,15 * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Preview changes without opening PR"
        type: boolean
        default: false
      force:
        description: "Force regeneration even if no changes detected"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

env:
  BRANCH_NAME: maint/dependency-refresh

jobs:
  refresh:
    name: Refresh Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pip-tools
        run: |
          pip install --upgrade pip
          pip install pip-tools

      - name: Check tool version alignment
        id: version-check
        run: |
          python scripts/sync_tool_versions.py --check || true
          echo "versions_ok=$?" >> $GITHUB_OUTPUT

      - name: Regenerate lockfiles
        id: compile
        run: |
          echo "## Dependency Refresh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Save original hashes
          LOCK_HASH_BEFORE=$(sha256sum requirements.lock 2>/dev/null | cut -d' ' -f1 || echo "none")
          DEV_HASH_BEFORE=$(sha256sum requirements-dev.lock 2>/dev/null | cut -d' ' -f1 || echo "none")
          
          # Regenerate lockfiles
          pip-compile --output-file=requirements.lock pyproject.toml
          pip-compile --extra=dev --output-file=requirements-dev.lock pyproject.toml
          
          # Check for changes
          LOCK_HASH_AFTER=$(sha256sum requirements.lock | cut -d' ' -f1)
          DEV_HASH_AFTER=$(sha256sum requirements-dev.lock | cut -d' ' -f1)
          
          if [[ "$LOCK_HASH_BEFORE" != "$LOCK_HASH_AFTER" ]] || [[ "$DEV_HASH_BEFORE" != "$DEV_HASH_AFTER" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✅ **Changes detected** in lockfiles" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️ **No changes** - lockfiles are up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Show diff
        if: steps.compile.outputs.has_changes == 'true'
        run: |
          echo "### requirements.lock changes:" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          git diff requirements.lock >> $GITHUB_STEP_SUMMARY || echo "New file" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "### requirements-dev.lock changes:" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          git diff requirements-dev.lock >> $GITHUB_STEP_SUMMARY || echo "New file" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        if: |
          steps.compile.outputs.has_changes == 'true' &&
          (github.event.inputs.dry_run != 'true')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): refresh dependency lockfiles"
          title: "chore(deps): refresh dependency lockfiles"
          body: |
            ## Dependency Refresh

            This PR updates the dependency lockfiles generated by `pip-compile`.

            ### Changes
            - Regenerated `requirements.lock`
            - Regenerated `requirements-dev.lock`

            ### Verification
            - [ ] CI passes
            - [ ] No breaking changes in dependencies

            ---
            *This PR was automatically created by the Dependency Refresh workflow.*
          branch: ${{ env.BRANCH_NAME }}
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Dry run summary
        if: |
          steps.compile.outputs.has_changes == 'true' &&
          github.event.inputs.dry_run == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ **Dry run mode** - PR not created" >> $GITHUB_STEP_SUMMARY
          echo "Run without dry_run to create a PR with these changes." >> $GITHUB_STEP_SUMMARY
