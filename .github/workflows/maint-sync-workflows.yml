# Periodically checks if workflow files are out of sync with stranske/Workflows
# and creates a PR to update them if needed
#
# Note: Most scripts are now fetched via dual checkout in reusable workflows,
# so this only syncs thin caller workflow files and version pins.
name: Sync Workflows Check

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch latest from Workflows repo
        id: fetch
        run: |
          mkdir -p /tmp/workflows-latest
          
          # Thin caller templates (these delegate to reusable workflows)
          SYNC_FILES=(
            "agents-orchestrator.yml"
            "agents-pr-meta.yml"
            "autofix.yml"
          )
          
          for file in "${SYNC_FILES[@]}"; do
            curl -sfL "https://raw.githubusercontent.com/stranske/Workflows/main/templates/consumer-repo/.github/workflows/${file}" \
              -o "/tmp/workflows-latest/${file}"
          done
          
          # Version pins
          curl -sfL "https://raw.githubusercontent.com/stranske/Workflows/main/.github/workflows/autofix-versions.env" \
            -o "/tmp/workflows-latest/autofix-versions.env"
          
          # Check for differences in workflows
          CHANGES=""
          for file in "${SYNC_FILES[@]}"; do
            # Map template names to local names
            local_file="$file"
            if [ "$file" = "agents-orchestrator.yml" ]; then
              local_file="agents-70-orchestrator.yml"
            fi
            
            if [ -f ".github/workflows/$local_file" ]; then
              # Compare ignoring first 10 lines (repo-specific headers)
              if ! diff -q <(tail -n +10 "/tmp/workflows-latest/$file") <(tail -n +10 ".github/workflows/$local_file") > /dev/null 2>&1; then
                CHANGES="$CHANGES workflows/$local_file"
              fi
            fi
          done
          
          # Check version pins (just key versions, not all)
          for key in BLACK_VERSION RUFF_VERSION MYPY_VERSION PYTEST_VERSION; do
            template_val=$(grep "^${key}=" "/tmp/workflows-latest/autofix-versions.env" | cut -d= -f2)
            local_val=$(grep "^${key}=" ".github/workflows/autofix-versions.env" | cut -d= -f2 || echo "")
            
            if [ -n "$local_val" ] && [ "$template_val" != "$local_val" ]; then
              CHANGES="$CHANGES versions/${key}"
            fi
          done
          
          if [ -n "$CHANGES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$CHANGES" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Workflow Sync Check" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.fetch.outputs.has_changes }}" = "true" ]; then
            echo "⚠️ Changes detected:" >> "$GITHUB_STEP_SUMMARY"
            echo "${{ steps.fetch.outputs.changed_files }}" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Run [Maint 68 Sync Consumer Repos](https://github.com/stranske/Workflows/actions/workflows/maint-68-sync-consumer-repos.yml) to update." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ All workflows in sync with stranske/Workflows" >> "$GITHUB_STEP_SUMMARY"
          fi
